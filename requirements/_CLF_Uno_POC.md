### Notes on the Uno POC

Steve T, October 2020, for discussion (v1)

The proof-of-concept project demonstrates an interactive 'Viewer' component for Intensity Map images.

Thanks to the magic of Uno, the Viewer runs on Windows/UWP, on Linux, on an Android tablet, and as a Web page.

The images that we work with in this demo are simulated, rather than being acquired in real time from a camera. It is CLF's intention to evolve the Viewer demo into a useful utility that will (A) connect to live sources of image data, and (B) will utilise the WinUI-3 framework rather than UWP. If time allows, and if the WinUI-3 preview looks to be stable enough, we will consider migrating to WinUI as part of the POC ; however the primary target here is UWP, which is well proven and stable.

#### Overall structure : Viewer Component and two 'Apps'

The project will develop a reusable component, the 'IntensityMapViewer', and two simple Apps that demonstrate its use.

The Viewer component will be packaged as an Assembly (ie a DLL) that is referenced by the two demo Apps.

The apps look roughly like this :

    +-----------------------------------------------+---+---+
    | Intensity Map Viewer                          | - | x |
    +-----------------------------------------------+---+---+
    |                                                       |
    |                                                       |
    |    Single panel, with two sections :                  |
    |                                                       |
    |    1. Navigation control (eg a list box               |
    |       or maybe a List View) that selects              |
    |       which Source is displayed                       |
    |                                                       |
    |    2. Display panel showing the Intensity Map         |
    |       associated with the seected Source              |
    |                                                       |
    |                                                       |
    +-------------------------------------------------------+
    | Status bar ?                                          |
    +-------------------------------------------------------+

    +-----------------------------------------------+---+---+
    | Test Harness App                              | - | x |
    +--------------+--------------------------------+---+---+
    | Menu bar ?                                            |
    +-------------------------------------------------------+
    |              |                                        |
    |  Navigation  |                                        |
    |  panel       |   Main panel                           |
    |              |                                        |
    |  Selects     |   Shows one of various 'pages'         |
    |  content     |   as selected by navigation panel      |
    |  of          |                                        |
    |  main        |   1. Viewer plus a Source selector     |
    |  panel       |   2. Panel displaying debug messages   |
    |              |   3  Other UI panels tbd|              |                                        |
    |              |                                        |
    +--------------+----------------------------------------+
    | Status bar ?                                          |
    +-------------------------------------------------------+

The 'viewer' app is just that, a viewer. It has two sections : the Viewer itself, and a Navigation control that selects the source of the data that's being displayed by the Viewer.

The 'test harness' app has a navigation pane at the left, where the selection made here determines the content shown in the 'main panel'. For the demo there will be just two choices : (A) a page that shows the same content as the Viewer app, and (B) a page that shows textual debug messages generated by the Viewer. Going forward, we'll add further pages that exercise other UI controls that we develop at CLF, for example controls that render a Synoptic, a Motor Control panel, and a Dependency Network. 

By having two apps that use the same Viewer component, we'll be demonstrating that we've mastered the techniques necessary to encapsulate the code and resources for a UI control in a distinct Assembly.

The apps won't be in communication with 'real' data sources such as cameras and motors ; for the demo, everything will be simulated. The idea here is to exercise the IntensityMapViewer from the point of view of (A) functionality and appearance, and (B) performance.

#### View Models

The UI for the Viewer will be backed by ViewModel classes coded in C#, for which CLF will provide an initial implementation. We'll use the MVVM library from the Community Toolkit.

Where we're simulating 'live' data such as streams of camera images, an internal timer will trigger the ViewModels to cycle through a baked-in sequence of snapshots loaded from resource files, at a rate of up to 30fps.

Rather than have the entire UI defined in a single 'flat' ViewModel, we'll structure things so that there are distinct ViewModels for distinct aspects of the overall Viewer control. This will make it easier for us to develop variants of the Viewer in future, for example something that displays several Intensity Map images side by side. 

Provisionally, we'll define VM's for
- Viewer (top level VM, composed of other VM's plus some simple flags and Commands)
- ImageDisplay, with optional 'Profile' graphs and Pan/Zoom functionality
- CameraSettings (to control gain, exposure etc)
- DisplaySettings (false-colour selection, enabling profile graphs etc)

Probably each of these VM's will be associated with a UserControl that provides the visuals. The 'main' UserControl for the Viewer will contain instances of the other UserControls, mirroring the composition structure of the VM's.

*Just ideas, we'll take advice on this !!*

#### IntensityMap visuals

This is a screen shot of our existing display :

![](Area%20Detector%20display%20screen%20shot.png)

We don't need to replicate this entirely, the following sketches indicate the aspects we're most interested in for the demo.

    [ Screen shots here of our Balsamiq wireframes ]

#### Domain Model

Let's briefly mention
- Laser beam
- Cameras
- Intensity Map and Profiles
- Laser Scientist

The raw image data captured by a camera is always in 'grey-scale' format ; typically 320x240 pixels with 8 bit pixels that represent an intensity ('brightness') from 0 (black) to 255 (white). When an image is displayed on screen, a mapping formula is applied which typically (A) normalises the pixel values to a specified maximum value, and (B) maps the normalised values into false colours via a palette.

#### Use Cases

Briefly, what does a Laser Scientist want to do ?

##### Check the laser alignment

- Change to the appropriate source (ie a particular camera).
- Adjust the settings (Gain and/or Exposure Time) for that source until the maximum intensity value in the captured image is suitable, say between 100 and 200 as a rough guide.
- Check that the current beam position is in the correct location. Just check the pixel position of the beam in this case. Adjust the optical path as necessary.
- Switch to another source and do the same.

##### Check the laser beam spatial profile 

First, look at overall picture :
- Select the source you want.
- Set the intensity scaling to auto.
- Reposition the profile location so that the cross-sections are taken through the laser spot.
- Look at the cross-section graphs to check they look good. In the real world, would adjust the optics until the graphs are ok.

Then look at low level signals, that can cause problems :
- Change from automatic to manual gain, and set the gain level nice and high so that the low level noise in the image shows up. The higher intensity parts of the image will saturate, but never mind.
- Inspect the (rescaled) cross-section plots and the image, to check that not too much signal is in the area outside of the main laser spot.

##### Save an image of the laser spot

- Set the gain/display values to show the spot nicely.
- Apply the colour palette of choice so the image is coloured as desired.
- Export the current image (with false colours applied) to a standard file format.

##### Check the laser spot for abnormalities

- Bring up desired source.
- Adjust the gain and max intensity values to get a clear image.
- Pan/zoom in to the region around the laser spot in the image.
- Check the image and cross-sections for smoothness. Are there any sudden variations in intensity ? We don't want images and profiles to be too 'spiky'.

#### Detailed description of the required functionality

Referring to the Balsamiq wireframes, we explain here *exactly* how you interact with the UI.

- Selecting a source of data
- Configuring the 'source' settings
- Choosing how the image is displayed (normalisation, colour map)
- Enabling/disabling the Profile graphs (explaining exactly what they show)
- Choosing the X/Y coordinates for the Profile graphs (mouse click, numeric entry)
- Pan and zoom on the image
- Saving to a file (??? freeze ???)
- Simulating errors such as loss-of-comms (tbd, maybe have a check box on the status bar ?)
- Resizing the window (image display changes size to make use of available space).
- Closing and re-starting, settings are preserved (?)
- Selecting a different Theme (? colours adjusted for use when wearing goggles ?)

Here's a sketch to identify the regions we'll be talking about :

    +-----------------------------------------------+
    | Source-Selector                               |
    +-----------------------------------------------+

    Intensity-Map-Panel
    +---------------------------------------------------------------------+
    | +-----------------------------------------+ +---------------------+ |
    | |                                         | | Image               | |    
    | |  Intensity-Map-Display                  | | Presentation        | |
    | |                                         | | Settings            | |
    | |  ### +-------------------------------+  | |                     | |
    | |  ### |        |                      |  | +---------------------+ |
    | |  ### |        |                      |  | +---------------------+ |
    | |  ### | - - - -+- - - - - - - - - - - |  | | Profile             | |
    | |  ### |        |                      |  | | Graph               | |
    | |  ### |        |                      |  | | Settings            | |
    | |  ### |        |                      |  | |                     | |
    | |  ### |        |                      |  | +---------------------+ |
    | |  ### +-------------------------------+  | +---------------------+ |
    | |                                         | | Source Settings ... | |
    | |      #################################  | +---------------------+ |
    | |      #################################  | +---------------------+ |
    | |                                         | | Save Image ...      | |
    | +-----------------------------------------+ +---------------------+ |
    +---------------------------------------------------------------------+

The 'Source-Selector' is an independent UserControl that might contain a combo box or a tree view as discussed earlier. It is not part of the 'Intensity-Map-Panel', but it determines which 'Source' is displayed in that Panel.

The Intensity-Map-Panel is a UserControl that is composed of several other UserControls :
- An Intensity-Map-Display. This presents an image in either grey scale or false colours, and also (if enabled) graphs of the horizontal and vertical intensity profiles.
- An 'Image-Presentation-Settings' panel to configure how the underlying 8-bit pixel data is presented as an RGB image.
- A 'Profile-Graph-Settings' panel that configures the graph displays below and to the left of the image.
- A button to bring up a panel that configures the settings of the current Source, including the camera's gain and exposure time.
- A button to bring up a modal dialog that lets you save the current image as a disk file.

Generally speaking, when you hover over something a useful tooltip pops up.
- When you hover over the image, to tooltip shows the X-Y coordinate (in terms of Source pixel indeces)and the un-normalised intensity value.
- When you hover over a button, the tooltip provides a brief explanation of what will happen if you click.
- When you hover over a UI element that is disabled (greyed-out) the tooltip explains why that feature is not available. For example if the Source Settings button is greyed out because that Panel is already active, the tooltip will mention that.

Keyboard shortuts will be provided for common actions, tbd. 

We might also make use of the mouse wheel for making certain adjustments, possibly in conjunction with the Shift and Ctrl keys. Details tbd, but the scroll wheel will be very handly for zooming in and out of the image, and also might provide a very convenient way to tweak the 'max intensity value' that we'll describe later.

We'll now describe the details of how this works.

##### The 'intensity map' display

This is the most interesting and important element in the UI. It shows a greyscale or false-colour image that represents the beam intensity as aquired by the selected Source. 

Alongside the image are graphs that show cross-sections through the data at particular X and Y coordinates. The left hand graph shows the intensity values along a vertical slice centred on the specified point, the graph at the bottom shows values along a horizontal slice.

Cross-hairs are overlaid onto the image to indicate the X-Y position, as indicated in the superb ASCII-art above. You can adjust the X-Y position in various ways : 
- via the controls in the 'Profile-Settings' panel
- by double-clicking on the image
- by dragging the vertical or horizontal cross-hair lines or the point where they intersect.

The colour and thickness of the cross-hair lines can be configured in the Preferences panel.

*Is there a better name for the X-Y position ? Profile reference position ??*

You can pan and zoom the image, to zero in on interesting features. This will be controlled by mouse gestures or touch gestures, and keyboard shortcuts, details tbd.

##### Intensity graphs

The graphs indicate the intensity along a particular slice of the intensity map, as determined by the X-Y position. 

*Does the graph draw straight lines between adjacent points, or does it draw vertical lines to indicate the value at each point ?*

It might be useful to show tick marks and numeric labels, but this is not essential as the information can be obtained via tooltips.

*We would prefer that the graphs for the POC are implemented using custom code in SkiaSharp, as this will give us an excuse to see how to do graphics in Skia.*

The graphs keep in sync (instantly!) as you change the X-Y position and pan/zoom the image.

##### Selecting a source of data

There's a choice of several sources, each corresponding to a camera. The available 'source' options might be visually presented in various ways, for example
- With a combo box with a drop down list of textual summaries. Each line would show the name of the source, and indicate whether it's online or offline.
- As a list presented at the left hand side, or possibly a tree (where sources that are related in some way would be presented as a group).
- As a preview panel that shows not only the source names and their statuses, but also a thumbnail image from the camera.

You are permitted to select a source that's currently offline, but the image will be blank.

All of these presentation formats would be possible without changing the underlying code. The 'ViewModel' for a source provides all the information required, and how to present it is a separate choice.

For the demo, all the sources will be simulated. They will differ in terms of the size of the image, the character of the image (nice images, poor images with noise and so on), and the update rate.

Once you've selected a source, the UI gets updated to show that source.

If a source goes offline while it's selected as the active one, the display will go blank. Or maybe it should freeze, and continue to show the most recently acquired image. In either case there will be a prominent indication on the UI, eg the background will go purple (tbd).

*QUESTION : do we restore settings for X/Y, colour-map etc that were in force when we last worked with that source ? Or do we leave them all as they are, as far as possible, noting that X/Y settings may have to be adjusted if the new image is a different size. Or do we reset them to defaults ?*

*Choices such as this could be made via a 'Preferences' setting, nice-to-have. This where we'd select a Theme, and maybe things such as a font-size-scale that could tune the visuals for differently sized screens ?*

*QUESTION : should we be displaying a timestamp or sequence number associated with the image ?*

##### Configuring the 'source' settings

Clicking on the 'Source Settings' button brings up a modal dialog (see Balsamiq wireframe) that controls how the image is acquired by the camera associated with the currently active Source. Image acquisition continues, and image updates continue to happen, but interaction with the main panel is disabled while the dialog is active. So for example you can't change which Source is selected, or modify the Normalisation. *Is 'modal' behaviour OK ? Or should this be a 'modeless' window which floats above the main panel, and doesn't prevent you from interacting with it ? In which case it would change appropriately if you were to select a different source.*

While the dialog is active you can adjust the Gain and the Exposure time. Changes in these values are reflected immediately in the image display ; increasing the Gain or exposure time will make the intensity of the next acquired image brighter.

Adjustments can be made either via sliders or by text entry. Text entries are validated, and changes are applied when focus leaves the text box or when you press 'ENTER'.

Gain values are constrained to be in the range 0 to 1000.

Exposure times can be be between 2uS and 100uS, selected either via the slider or via the combo box that offers the valid options.

The 'Trigger' option has no effect in the demo. *Hmm, maybe instead of this have a choice of image update rates, eg 1/2/5/10/30 frames per second ?*

*QUESTION : Binning ? Easy to do in the ViewModel. Or is binning not relevant for images of this fairly small size ?. Could be done either here (since it's usually done in the Camera) or in the 'presentation settings' panel.*

##### Choosing how the intensity map data is presented 

This panel lets you adjust the Normalisation and select the Colour Map.

Normalisation can be either Manual or Automatic. In 'manual' mode you specify a 'maximum intensity value', say 100, and the pixel values in the image will all be scaled such that those with a nominal value of 100 or above will get mapped to the highest intensity value, 255. The logic for this will be implemented in the ViewModel. In 'auto' mode, the maximum value is determined by scanning the image data and finding the brightest pixel.

The maximum intensity value can be set via a sider or via text entry. In 'auto' mode, the slider and the text box are read-only, and they indicate the maximum value that has been found. When you transition from 'auto' to 'manual' mode, the value stays the same until you change it.

The 'colour map' chooser is a combo box that offers a choice of three options : greyscale, the 'JET' colour scheme, or Binary. With 'binary' selected, the pixels are mapped to Black or White depending on whether the value is below or above the 'maximum intensity value'. The 'binary' option is greyed out when you're in Automatic mode.

*Binary mode is a novel idea, maybe not useful but it gives us an excuse to do some interesting logic in the View Model and UI.*

##### Enabling/disabling the Profile graphs

If you disable the displaying of the graphs, the Image expands to fill the available space.

##### Choosing the X/Y coordinates for the Profile graphs

Mouse click, numeric entry, dragging the cross hairs. ALREADY DESCRIBED ABOVE.

##### Pan and zoom on the image

ALREADY DESCRIBED ABOVE.

##### Saving to a file

DISCUSS - Freeze ???

##### Simulating errors such as loss-of-comms

Tbd, maybe have a check box on the status bar ?

##### Resizing the window 

Image display changes size to make use of the available space.

##### Closing and re-starting, settings are preserved (?)

TO DISCUSS.

##### Selecting a different Theme (?)

Colours adjusted for use when wearing goggles.

##### Preference Settings ?

Useful to incude this as it's a commonly needed feature and we'd like to see how best to do it.










